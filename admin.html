<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Bollywood Day 2026</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --gold: #FFD700; --crimson: #C0152A; --orange: #FF6B00; --dark: #0D0005; --card: rgba(255,255,255,0.05); }
    body { font-family: 'Poppins', sans-serif; background: var(--dark); color: #fff; min-height: 100vh; }
    .bg { position: fixed; inset: 0; background: radial-gradient(ellipse at 20% 20%, #3a0008 0%, transparent 55%), radial-gradient(ellipse at 80% 80%, #2a1000 0%, transparent 55%), #0D0005; }

    /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
    .login-wrap { position: relative; z-index: 1; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-box {
      background: var(--card); border: 1px solid rgba(255,215,0,0.2); border-radius: 24px;
      padding: 48px 40px; width: 100%; max-width: 420px;
      backdrop-filter: blur(12px); box-shadow: 0 0 60px rgba(192,21,42,0.2);
      animation: fadeUp 0.7s ease both;
    }
    @keyframes fadeUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
    .login-icon { text-align: center; font-size: 3rem; margin-bottom: 8px; }
    .login-title { font-family: 'Playfair Display', serif; font-size: 1.8rem; text-align: center; color: var(--gold); margin-bottom: 4px; }
    .login-sub { text-align: center; font-size: 0.82rem; color: rgba(255,255,255,0.4); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 32px; }
    .field { margin-bottom: 20px; }
    .field label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.45); margin-bottom: 8px; }
    .field input {
      width: 100%; background: rgba(255,255,255,0.06); border: 1.5px solid rgba(255,215,0,0.2);
      border-radius: 12px; padding: 13px 16px; font-family: 'Poppins', sans-serif;
      font-size: 0.95rem; color: #fff; outline: none; transition: border-color 0.3s, box-shadow 0.3s;
    }
    .field input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(255,215,0,0.1); }
    .field input::placeholder { color: rgba(255,255,255,0.2); }
    .btn-login {
      width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer;
      background: linear-gradient(135deg, #FFD700, #FF6B00, #C0152A);
      background-size: 200% auto; font-family: 'Playfair Display', serif;
      font-size: 1.1rem; font-weight: 700; color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,0.4);
      transition: background-position 0.4s, transform 0.2s; box-shadow: 0 4px 20px rgba(255,107,0,0.3);
    }
    .btn-login:hover { background-position: right center; transform: translateY(-1px); }
    .btn-login:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .login-err { color: #ff6b6b; font-size: 0.82rem; text-align: center; margin-top: 12px; display: none; padding: 10px; background: rgba(255,107,107,0.08); border-radius: 8px; }

    /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
    #dashboard { display: none; position: relative; z-index: 1; min-height: 100vh; }
    .topbar {
      background: rgba(255,255,255,0.04); border-bottom: 1px solid rgba(255,215,0,0.15);
      padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
      backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 10;
    }
    .topbar-brand { font-family: 'Playfair Display', serif; font-size: 1.3rem; color: var(--gold); }
    .topbar-brand span { font-size: 0.72rem; font-family: 'Poppins', sans-serif; color: rgba(255,255,255,0.35); display: block; letter-spacing: 2px; text-transform: uppercase; }
    .topbar-actions { display: flex; gap: 10px; align-items: center; }
    .btn-sm {
      padding: 9px 18px; border-radius: 10px; font-size: 0.82rem; font-family: 'Poppins', sans-serif;
      font-weight: 600; cursor: pointer; transition: all 0.25s; border: none;
    }
    .btn-download { background: linear-gradient(135deg, var(--gold), var(--orange)); color: #000; }
    .btn-download:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,215,0,0.3); }
    .btn-logout { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.12); }
    .btn-logout:hover { background: rgba(255,255,255,0.14); color: #fff; }

    .main { padding: 32px; max-width: 1100px; margin: 0 auto; }

    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(175px, 1fr)); gap: 14px; margin-bottom: 28px; }
    .stat-card {
      background: var(--card); border: 1px solid rgba(255,215,0,0.12); border-radius: 16px;
      padding: 20px 22px; text-align: center; transition: border-color 0.3s, transform 0.2s;
    }
    .stat-card:hover { border-color: rgba(255,215,0,0.35); transform: translateY(-2px); }
    .stat-icon { font-size: 2rem; margin-bottom: 6px; }
    .stat-num { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 700; color: var(--gold); }
    .stat-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.35); margin-top: 2px; }

    /* Table */
    .table-wrap { background: var(--card); border: 1px solid rgba(255,215,0,0.12); border-radius: 20px; overflow: hidden; }
    .table-head {
      padding: 18px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
      border-bottom: 1px solid rgba(255,215,0,0.1);
    }
    .table-title { font-family: 'Playfair Display', serif; font-size: 1.2rem; color: var(--gold); }
    .search-box {
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,215,0,0.15);
      border-radius: 10px; padding: 8px 14px; color: #fff; font-family: 'Poppins', sans-serif;
      font-size: 0.85rem; outline: none; width: 220px; transition: border-color 0.3s;
    }
    .search-box:focus { border-color: rgba(255,215,0,0.4); }
    .search-box::placeholder { color: rgba(255,255,255,0.25); }

    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 560px; }
    thead th {
      padding: 12px 18px; text-align: left; font-size: 0.7rem; text-transform: uppercase;
      letter-spacing: 2px; color: rgba(255,255,255,0.3); border-bottom: 1px solid rgba(255,255,255,0.06);
      font-weight: 500; white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.2s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(255,215,0,0.03); }
    tbody td { padding: 13px 18px; font-size: 0.87rem; color: rgba(255,255,255,0.8); }

    .id-badge {
      background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.25);
      color: var(--gold); padding: 3px 10px; border-radius: 20px; font-size: 0.76rem;
      font-weight: 600; letter-spacing: 1px; white-space: nowrap;
    }
    .act-chip { padding: 4px 12px; border-radius: 20px; font-size: 0.74rem; font-weight: 600; white-space: nowrap; }
    .act-Dance { background: rgba(255,20,147,0.15); color: #ff69b4; border: 1px solid rgba(255,20,147,0.25); }
    .act-Singing { background: rgba(255,215,0,0.12); color: var(--gold); border: 1px solid rgba(255,215,0,0.25); }
    .act-Acting { background: rgba(255,107,0,0.15); color: #ff8c42; border: 1px solid rgba(255,107,0,0.25); }

    /* Delete button */
    .btn-delete {
      background: rgba(192,21,42,0.15); border: 1px solid rgba(192,21,42,0.35);
      color: #ff6b6b; padding: 5px 12px; border-radius: 8px; font-size: 0.76rem;
      font-family: 'Poppins', sans-serif; font-weight: 600; cursor: pointer;
      transition: all 0.2s; white-space: nowrap;
    }
    .btn-delete:hover { background: rgba(192,21,42,0.35); border-color: #ff6b6b; color: #fff; transform: scale(1.05); }
    .btn-delete:active { transform: scale(0.98); }
    .btn-delete:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* Confirm modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 100;
      display: none; align-items: center; justify-content: center; padding: 20px;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.show { display: flex; }
    .modal-box {
      background: #1a0010; border: 1px solid rgba(255,215,0,0.2); border-radius: 20px;
      padding: 36px 32px; max-width: 380px; width: 100%; text-align: center;
      animation: fadeUp 0.3s ease both; box-shadow: 0 0 60px rgba(192,21,42,0.3);
    }
    .modal-icon { font-size: 2.5rem; margin-bottom: 12px; }
    .modal-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: #fff; margin-bottom: 8px; }
    .modal-sub { color: rgba(255,255,255,0.5); font-size: 0.88rem; line-height: 1.6; margin-bottom: 24px; }
    .modal-name { color: var(--gold); font-weight: 600; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; }
    .btn-cancel { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); padding: 11px 24px; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 0.88rem; cursor: pointer; transition: all 0.2s; }
    .btn-cancel:hover { background: rgba(255,255,255,0.14); color: #fff; }
    .btn-confirm-delete { background: var(--crimson); border: none; color: #fff; padding: 11px 24px; border-radius: 10px; font-family: 'Poppins', sans-serif; font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 16px rgba(192,21,42,0.4); }
    .btn-confirm-delete:hover { background: #a0102a; transform: translateY(-1px); }

    .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.3); }
    .empty-state .e-icon { font-size: 3rem; margin-bottom: 12px; display: block; }
    .loading { text-align: center; padding: 60px; color: rgba(255,255,255,0.35); }

    /* Toast */
    .toast {
      position: fixed; bottom: 28px; right: 28px; z-index: 200;
      background: rgba(30,30,30,0.95); border: 1px solid rgba(255,215,0,0.2);
      border-radius: 12px; padding: 14px 20px; font-size: 0.88rem;
      opacity: 0; transform: translateY(12px); transition: all 0.3s;
      pointer-events: none; max-width: 320px;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { border-color: rgba(72,199,142,0.4); color: #48c78e; }
    .toast.error { border-color: rgba(255,107,107,0.4); color: #ff6b6b; }

    @media (max-width: 640px) {
      .topbar { padding: 14px 16px; flex-wrap: wrap; gap: 10px; }
      .main { padding: 20px 14px; }
      .search-box { width: 100%; }
    }
  </style>
</head>
<body>
<div class="bg"></div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-box">
    <div class="modal-icon">üóëÔ∏è</div>
    <div class="modal-title">Delete Registration?</div>
    <div class="modal-sub">You're about to remove <span class="modal-name" id="modalName"></span> (<span id="modalRegId"></span>). This cannot be undone.</div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-confirm-delete" id="confirmDeleteBtn" onclick="confirmDelete()">Yes, Delete</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Login -->
<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="login-icon">üîê</div>
    <div class="login-title">Organiser Login</div>
    <div class="login-sub">Bollywood Day 2026 ¬∑ Admin</div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="passwordInput" placeholder="Enter admin password" onkeydown="if(event.key==='Enter') doLogin()"/>
    </div>
    <button class="btn-login" id="loginBtn" onclick="doLogin()">üé¨ Enter Dashboard</button>
    <div class="login-err" id="loginErr">‚ùå Invalid password. Try again.</div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="topbar">
    <div class="topbar-brand">
      üé¨ Bollywood Day 2026
      <span>Organiser Dashboard</span>
    </div>
    <div class="topbar-actions">
      <button class="btn-sm btn-download" onclick="downloadExcel()">‚¨á Download Excel</button>
      <button class="btn-sm btn-logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="stats">
      <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-num" id="totalCount">‚Äî</div><div class="stat-label">Total Registered</div></div>
      <div class="stat-card"><div class="stat-icon">üíÉ</div><div class="stat-num" id="danceCount">‚Äî</div><div class="stat-label">Dance</div></div>
      <div class="stat-card"><div class="stat-icon">üé§</div><div class="stat-num" id="singingCount">‚Äî</div><div class="stat-label">Singing</div></div>
      <div class="stat-card"><div class="stat-icon">üé≠</div><div class="stat-num" id="actingCount">‚Äî</div><div class="stat-label">Acting</div></div>
    </div>

    <div class="table-wrap">
      <div class="table-head">
        <div class="table-title">All Registrations</div>
        <input class="search-box" placeholder="üîç Search name / ID‚Ä¶" oninput="filterTable(this.value)"/>
      </div>
      <div class="table-scroll">
        <div id="tableContainer"><div class="loading">‚è≥ Loading registrations‚Ä¶</div></div>
      </div>
    </div>
  </div>
</div>

<script>
  let token = sessionStorage.getItem('bld_token');
  let allRegs = [];
  let pendingDeleteId = null;
  let pendingDeleteBtn = null;

  if (token) showDashboard();

  async function doLogin() {
    const pw = document.getElementById('passwordInput').value;
    const btn = document.getElementById('loginBtn');
    btn.disabled = true; btn.textContent = 'Verifying‚Ä¶';
    try {
      const res = await fetch('/api/admin/login', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password: pw })
      });
      const data = await res.json();
      if (!res.ok) throw new Error();
      token = data.token;
      sessionStorage.setItem('bld_token', token);
      showDashboard();
    } catch {
      document.getElementById('loginErr').style.display = 'block';
      btn.disabled = false; btn.textContent = 'üé¨ Enter Dashboard';
    }
  }

  function showDashboard() {
    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadRegistrations();
  }

  function logout() {
    sessionStorage.removeItem('bld_token');
    token = null;
    document.getElementById('loginWrap').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('passwordInput').value = '';
    document.getElementById('loginErr').style.display = 'none';
  }

  async function loadRegistrations() {
    try {
      const res = await fetch('/api/admin/registrations', { headers: { Authorization: 'Bearer ' + token } });
      if (res.status === 401) { logout(); return; }
      const data = await res.json();
      allRegs = data.registrations;
      updateStats(allRegs);
      renderTable(allRegs);
    } catch {
      document.getElementById('tableContainer').innerHTML = '<div class="empty-state"><span class="e-icon">‚ö†Ô∏è</span>Failed to load registrations.</div>';
    }
  }

  function updateStats(regs) {
    document.getElementById('totalCount').textContent = regs.length;
    document.getElementById('danceCount').textContent = regs.filter(r => r.act === 'Dance').length;
    document.getElementById('singingCount').textContent = regs.filter(r => r.act === 'Singing').length;
    document.getElementById('actingCount').textContent = regs.filter(r => r.act === 'Acting').length;
  }

  function renderTable(regs) {
    if (!regs.length) {
      document.getElementById('tableContainer').innerHTML = '<div class="empty-state"><span class="e-icon">üé¨</span>No registrations yet. Share the link!</div>';
      return;
    }
    const rows = regs.map(r => `
      <tr id="row-${r.reg_id}">
        <td><span class="id-badge">${r.reg_id || '‚Äî'}</span></td>
        <td>${escHtml(r.name || '‚Äî')}</td>
        <td>${escHtml(r.phone || '‚Äî')}</td>
        <td><span class="act-chip act-${r.act}">${r.act || '‚Äî'}</span></td>
        <td style="color:rgba(255,255,255,0.35);font-size:0.78rem">${r.registered_at || '‚Äî'}</td>
        <td>
          <button class="btn-delete" onclick="openDeleteModal('${r.reg_id}', '${escHtml(r.name)}', this)">
            üóë Delete
          </button>
        </td>
      </tr>`).join('');

    document.getElementById('tableContainer').innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Reg ID</th><th>Name</th><th>Phone</th>
            <th>Act</th><th>Registered At</th><th>Action</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  function escHtml(str) {
    return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function filterTable(q) {
    const lq = q.toLowerCase();
    const filtered = allRegs.filter(r =>
      (r.name || '').toLowerCase().includes(lq) ||
      (r.reg_id || '').toLowerCase().includes(lq) ||
      (r.phone || '').toLowerCase().includes(lq)
    );
    renderTable(filtered);
  }

  // ‚îÄ‚îÄ Delete flow ‚îÄ‚îÄ
  function openDeleteModal(regId, name, btn) {
    pendingDeleteId = regId;
    pendingDeleteBtn = btn;
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalRegId').textContent = regId;
    document.getElementById('deleteModal').classList.add('show');
  }

  function closeModal() {
    document.getElementById('deleteModal').classList.remove('show');
    pendingDeleteId = null;
    pendingDeleteBtn = null;
  }

  async function confirmDelete() {
    if (!pendingDeleteId) return;
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.disabled = true; confirmBtn.textContent = 'Deleting‚Ä¶';
    if (pendingDeleteBtn) { pendingDeleteBtn.disabled = true; }

    try {
      const res = await fetch(`/api/admin/registrations/${encodeURIComponent(pendingDeleteId)}`, {
        method: 'DELETE', headers: { Authorization: 'Bearer ' + token }
      });
      if (res.status === 401) { logout(); return; }
      if (!res.ok) throw new Error('Delete failed');

      // Remove row from UI
      const row = document.getElementById(`row-${pendingDeleteId}`);
      if (row) { row.style.transition = 'opacity 0.3s'; row.style.opacity = '0'; setTimeout(() => row.remove(), 300); }

      // Update local data
      allRegs = allRegs.filter(r => r.reg_id !== pendingDeleteId);
      updateStats(allRegs);

      closeModal();
      showToast('‚úÖ Registration deleted successfully', 'success');
    } catch {
      closeModal();
      showToast('‚ùå Failed to delete. Please try again.', 'error');
      if (pendingDeleteBtn) { pendingDeleteBtn.disabled = false; }
    }

    confirmBtn.disabled = false; confirmBtn.textContent = 'Yes, Delete';
  }

  // Close modal on overlay click
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  // ‚îÄ‚îÄ Download ‚îÄ‚îÄ
  async function downloadExcel() {
    const res = await fetch('/api/admin/download', { headers: { Authorization: 'Bearer ' + token } });
    if (res.status === 401) { logout(); return; }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'bollywood-day-registrations.xlsx';
    a.click();
    showToast('üì• Excel file downloaded!', 'success');
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 3500);
  }

  // Auto-refresh every 30s
  setInterval(() => { if (token) loadRegistrations(); }, 30000);
</script>
</body>
</html>